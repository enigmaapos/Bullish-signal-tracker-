<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>EMA Wick Detector ‚Äî Safe Mode (PH Time)</title>
<style>
:root{
  --bg:#071022;--card:#0b1220;--muted:#8aa3bf;--accent:#38bdf8;
  --success:#22c55e;--danger:#ef4444;--table:#0f1726;--glow:0 8px 30px rgba(56,189,248,0.08)
}
body{background:var(--bg);color:#e6eef8;font-family:Inter,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:20px}
.wrap{max-width:1100px;margin:0 auto}
.card{background:var(--card);padding:18px;border-radius:12px;box-shadow:var(--glow)}
h1{margin:0 0 8px;color:var(--accent)}
p{color:var(--muted);margin:6px 0 14px}
.controls{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
button{border:0;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
#greenBtn{background:linear-gradient(90deg,#16a34a,#22c55e);color:#04201a}
#redBtn{background:linear-gradient(90deg,#dc2626,#ef4444);color:#fff}
#downloadBtn{background:#334155;color:#e6eef8}
.meta{font-size:13px;color:var(--muted);margin-bottom:8px}
.progress{margin-top:8px}
.bar{height:12px;background:#061826;border-radius:8px;overflow:hidden}
.bar-inner{height:100%;width:0;background:linear-gradient(90deg,var(--accent),#60a5fa);transition:width .25s}
table{width:100%;border-collapse:collapse;margin-top:14px;background:var(--table);border-radius:8px;overflow:hidden}
thead th{background:linear-gradient(90deg,#041828,#092133);padding:12px;text-align:left;font-size:13px;color:#cfeefe;border-bottom:1px solid rgba(255,255,255,0.03)}
tbody td{padding:10px 12px;font-size:13px;color:#e6eef8;border-bottom:1px solid rgba(255,255,255,0.02)}
tbody tr:nth-child(even){background:rgba(255,255,255,0.01)}
.sym{font-weight:700;color:#f8fafc}
.date{color:#9fb8d1}
.status-green{background:rgba(34,197,94,0.08);color:var(--success);padding:6px 8px;border-radius:6px;display:inline-block}
.status-red{background:rgba(239,68,68,0.08);color:var(--danger);padding:6px 8px;border-radius:6px;display:inline-block}
.small{font-size:12px;color:var(--muted)}
.note{margin-top:10px;color:var(--muted);font-size:13px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>EMA Wick Detector ‚Äî Safe Mode</h1>
    <p>Scans Binance USDT-Perpetual pairs (1D PH Time). <br>Safe delay settings to avoid Binance rate limits.</p>
    <div class="controls">
      <button id="greenBtn">üü¢ Safe Scan (Green)</button>
      <button id="redBtn">üî¥ Safe Scan (Red)</button>
      <button id="downloadBtn" disabled>‚¨áÔ∏è Download</button>
    </div>
    <div class="meta">üïí Philippine Time (UTC+8) | Batch = 10 | Delay = 750 ms / symbol + 3 s / batch</div>
    <div class="progress">
      <div id="progressText" class="small">Idle</div>
      <div class="bar"><div id="barInner" class="bar-inner"></div></div>
    </div>
    <table id="resultsTable" style="display:none">
      <thead><tr><th>Symbol</th><th>Date (PH)</th><th>High</th><th>Low</th><th>EMA14</th><th>EMA70</th><th>24h %</th><th>Status</th></tr></thead>
      <tbody id="resultsBody"></tbody>
    </table>
    <div id="empty" class="note">No scan yet.</div>
  </div>
</div>

<script>
const CONFIG={
  BATCH_SIZE:10,
  DELAY_SYMBOL:750,
  DELAY_BATCH:3000,
  MAX_CANDLES:200,
  EMA14:14,
  EMA70:70,
  BLACKLIST:["ALPACAUSDT","BNXUSDT","ALPHAUSDT","OCEANUSDT","DGBUSDT","AGIXUSDT","LINAUSDT","LOKAUSDT","KEYUSDT","MDTUSDT","LOOMUSDT","RENUSDT","OMNIUSDT","SLERFUSDT","STMXUSDT","UXLINKUSDT","BSWUSDT","NEIROETHUSDT","VIDTUSDT","TROYUSDT","BAKEUSDT","AMBUSDT","MEMEFIUSDT","NULSUSDT","HIFIUSDT","LEVERUSDT","XEMUSDT","STRAXUSDT","COMBOUSDT"]
};

const el={
  g:document.getElementById('greenBtn'),
  r:document.getElementById('redBtn'),
  d:document.getElementById('downloadBtn'),
  t:document.getElementById('resultsTable'),
  b:document.getElementById('resultsBody'),
  e:document.getElementById('empty'),
  p:document.getElementById('progressText'),
  bar:document.getElementById('barInner')
};

let currentResults=[],running=false;

function sleep(ms){return new Promise(r=>setTimeout(r,ms));}

async function fetchJSON(url){const r=await fetch(url);if(!r.ok)throw new Error(url);return await r.json();}

async function fetchSymbols(){
  const data=await fetchJSON('https://fapi.binance.com/fapi/v1/exchangeInfo');
  return data.symbols.filter(s=>s.contractType==='PERPETUAL'&&s.symbol.endsWith('USDT')&&s.status==='TRADING')
    .map(s=>s.symbol).filter(s=>!CONFIG.BLACKLIST.includes(s));
}

async function fetchTickers(){
  const arr=await fetchJSON('https://fapi.binance.com/fapi/v1/ticker/24hr');
  const m=new Map();for(const t of arr)m.set(t.symbol,t);return m;
}

async function fetchKlines(sym){
  return await fetchJSON(`https://fapi.binance.com/fapi/v1/klines?symbol=${sym}&interval=1d&limit=${CONFIG.MAX_CANDLES}`);
}

function ema(vals,p){const k=2/(p+1),r=[vals[0]];for(let i=1;i<vals.length;i++)r.push(vals[i]*k+r[i-1]*(1-k));return r;}
function toPH(ms){const d=new Date(ms+8*3600*1000);return d.toISOString().replace('T',' ').split('.')[0];}

async function inspect(sym){
  try{
    const kl=await fetchKlines(sym);
    const c=kl.map(k=>+k[4]),h=kl.map(k=>+k[2]),l=kl.map(k=>+k[3]);
    const e14=ema(c,CONFIG.EMA14),e70=ema(c,CONFIG.EMA70),i=c.length-1;
    const u=Math.max(e14[i],e70[i]),lo=Math.min(e14[i],e70[i]);
    if(h[i]<=u&&l[i]>=lo)return{sym,date:toPH(kl[i][0]),high:h[i],low:l[i],ema14:e14[i],ema70:e70[i]};
  }catch{}
  return null;
}

async function runScan(type){
  if(running)return;running=true;
  currentResults=[];el.b.innerHTML='';el.t.style.display='none';el.bar.style.width='0%';
  el.e.textContent=`üü° Safe scanning ${type} market...`;el.g.disabled=el.r.disabled=true;
  el.g.textContent='üïí Scanning...';el.r.textContent='üïí Scanning...';el.p.textContent='Loading list...';

  try{
    const [syms,tmap]=await Promise.all([fetchSymbols(),fetchTickers()]);
    const list=syms.filter(s=>{const p=parseFloat(tmap.get(s)?.priceChangePercent||0);return type==='green'?p>0:p<0;});
    if(!list.length){el.e.textContent='No symbols.';return;}
    let done=0;
    for(let i=0;i<list.length;i+=CONFIG.BATCH_SIZE){
      const batch=list.slice(i,i+CONFIG.BATCH_SIZE);
      const batchRes=[];
      for(const s of batch){
        const r=await inspect(s);
        await sleep(CONFIG.DELAY_SYMBOL);
        done++;
        const pct=Math.min(100,(done/list.length*100)).toFixed(1);
        el.bar.style.width=pct+'%';
        el.p.textContent=`Progress: ${done}/${list.length} (${pct}%)`;
        if(r){
          const pctVal=parseFloat(tmap.get(s)?.priceChangePercent||0).toFixed(2);
          currentResults.push({...r,pct:pctVal});
          const tr=document.createElement('tr');
          tr.innerHTML=`<td class="sym">${r.sym}</td><td>${r.date}</td><td>${r.high}</td><td>${r.low}</td>
          <td>${r.ema14.toFixed(6)}</td><td>${r.ema70.toFixed(6)}</td><td>${pctVal}%</td>
          <td>${type==='green'?'<span class="status-green">Green</span>':'<span class="status-red">Red</span>'}</td>`;
          el.b.appendChild(tr);el.t.style.display='table';
        }
      }
      await sleep(CONFIG.DELAY_BATCH);
    }
    el.p.textContent=`‚úÖ Safe scan complete ‚Äî ${currentResults.length} matches.`;
    el.e.textContent=currentResults.length?`${currentResults.length} found.`:'No inside-wick candles found.';
    if(currentResults.length)el.d.disabled=false;
  }catch(e){el.e.textContent='Error: '+e.message;}
  finally{
    running=false;el.g.disabled=el.r.disabled=false;
    el.g.textContent='üü¢ Safe Scan (Green)';el.r.textContent='üî¥ Safe Scan (Red)';
  }
}

function downloadFile(type){
  if(!currentResults.length)return;
  const lines=currentResults.map(r=>`${r.sym} | ${r.date} | high=${r.high} low=${r.low} | EMA14=${r.ema14.toFixed(6)} EMA70=${r.ema70.toFixed(6)} | 24h%=${r.pct}`);
  const blob=new Blob([lines.join('\n')],{type:'text/plain'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);a.download=`ema_wick_${type}_safe_PH.txt`;a.click();
}

el.g.onclick=()=>{if(!running)runScan('green');};
el.r.onclick=()=>{if(!running)runScan('red');};
el.d.onclick=()=>downloadFile(currentResults[0]?.pct>0?'green':'red');
</script>
</body>
</html>
