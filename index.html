<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Binance Futures EMA Cross Detector</title>
<style>
  :root {
    --bg: #0e1117;
    --card: #161b22;
    --border: #2b313b;
    --accent: #f1c40f;
    --bull: #00ff88;
    --bear: #ff5555;
  }

  body {
    margin: 0;
    font-family: "Segoe UI", Arial, sans-serif;
    background: var(--bg);
    color: #e0e0e0;
  }

  h1 {
    color: var(--accent);
    margin: 20px 0 5px;
    text-align: center;
  }

  p {
    text-align: center;
    color: #aaa;
    margin: 0 0 20px;
  }

  .controls {
    text-align: center;
    margin-bottom: 10px;
  }

  button {
    background: var(--accent);
    color: #000;
    font-weight: bold;
    padding: 10px 18px;
    margin: 5px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
  }

  button:hover:not(:disabled) {
    transform: scale(1.03);
    box-shadow: 0 0 8px var(--accent);
  }

  button:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }

  .dashboard {
    max-width: 1200px;
    margin: auto;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 0 15px rgba(0,0,0,0.4);
  }

  .stats {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-around;
    margin: 15px 0;
  }

  .stat-box {
    background: #1b222d;
    border-radius: 10px;
    padding: 10px 20px;
    margin: 5px;
    text-align: center;
    min-width: 130px;
  }

  .stat-box span {
    display: block;
    font-size: 24px;
    font-weight: bold;
  }

  #progress-container {
    width: 100%;
    height: 10px;
    background: #2b2b2b;
    border-radius: 6px;
    overflow: hidden;
    margin: 15px 0;
  }

  #progress-bar {
    width: 0%;
    height: 100%;
    background: var(--accent);
    transition: width 0.3s;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
  }

  th, td {
    padding: 8px;
    border-bottom: 1px solid #2b2b2b;
    text-align: center;
    font-size: 13px;
  }

  th {
    color: var(--accent);
    background: #1e2530;
  }

  tr:nth-child(even) { background: #141a22; }
  tr:nth-child(odd) { background: #10151c; }

  .ok { color: var(--bull); font-weight: bold; }
  .bear { color: var(--bear); font-weight: bold; }

  @media (max-width: 700px) {
    table { font-size: 12px; }
    th, td { padding: 6px; }
  }
</style>
</head>
<body>
  <h1>Binance Futures EMA Cross Detector</h1>
  <p>Timeframe: 15m ‚Ä¢ Safe: 5 pairs/sec ‚Ä¢ Candles: 200 ‚Ä¢ Cooldown: 30s</p>

  <div class="controls">
    <button id="greenBullish">üü¢ Green Bullish</button>
    <button id="redBullish">üî¥ Red Bullish</button>
    <button id="greenBearish">üü¢ Green Bearish</button>
    <button id="redBearish">üî¥ Red Bearish</button>
  </div>

  <div class="dashboard">
    <div class="stats">
      <div class="stat-box" style="color:var(--bull)">
        Green Pairs <span id="greenCount">-</span>
      </div>
      <div class="stat-box" style="color:var(--bear)">
        Red Pairs <span id="redCount">-</span>
      </div>
      <div class="stat-box" style="color:var(--accent)">
        Found Crosses <span id="foundCount">0</span>
      </div>
    </div>

    <div id="progress-container"><div id="progress-bar"></div></div>
    <div id="progressText" style="text-align:center; margin-bottom:10px;"></div>

    <table>
      <thead>
        <tr>
          <th>Pair</th>
          <th>24h Change %</th>
          <th>EMA14</th>
          <th>EMA70</th>
          <th>EMA200</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="results"></tbody>
    </table>
  </div>

<script>
const apiBase = "https://fapi.binance.com";
const tf = "15m";
const candlesLimit = 200;
const concurrency = 10;       // ‚úÖ 10 pairs per batch
const delayMs = 1000;         // ‚úÖ 1s between batches (10/sec ‚Üí safe)
const recentLimit = 25;
const cooldownMs = 30000;     // ‚úÖ manual click cooldown
const autoRefreshInterval = 5 * 60 * 1000; // ‚úÖ 5-minute auto-update

let isScanning = false;
let lastScanTime = 0;
let autoRefreshTimer = null;

async function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

function ema(values, period){
  const k = 2 / (period + 1);
  let emaArr = [values[0]];
  for(let i=1;i<values.length;i++)
    emaArr.push(values[i]*k + emaArr[i-1]*(1-k));
  return emaArr;
}

function findBullishCross(ema70, ema200){
  for(let i=1;i<ema70.length;i++){
    if(ema70[i-1]<ema200[i-1] && ema70[i]>=ema200[i]) return i;
  }
  return -1;
}

function findBearishCross(ema70, ema200){
  for(let i=1;i<ema70.length;i++){
    if(ema70[i-1]>ema200[i-1] && ema70[i]<=ema200[i]) return i;
  }
  return -1;
}

async function fetchCandles(symbol){
  const res = await fetch(`${apiBase}/fapi/v1/klines?symbol=${symbol}&interval=${tf}&limit=${candlesLimit}`);
  const data = await res.json();
  return data.map(c=>parseFloat(c[4]));
}

async function get24hSymbols(){
  const res = await fetch(`${apiBase}/fapi/v1/ticker/24hr`);
  const data = await res.json();
  return data.map(t=>({
    symbol: t.symbol,
    change: parseFloat(t.priceChangePercent)
  }));
}

async function preloadCounts(){
  const tickers = await get24hSymbols();
  const greens = tickers.filter(t=>t.change>0 && t.symbol.endsWith("USDT")).length;
  const reds = tickers.filter(t=>t.change<0 && t.symbol.endsWith("USDT")).length;
  document.getElementById("greenCount").textContent = greens;
  document.getElementById("redCount").textContent = reds;
}

async function processSymbol({symbol, change}, mode){
  try{
    const closes = await fetchCandles(symbol);
    const ema14 = ema(closes,14);
    const ema70 = ema(closes,70);
    const ema200 = ema(closes,200);
    const last = ema14.length - 1;
    const crossFn = mode.includes("bullish") ? findBullishCross : findBearishCross;
    const crossIdx = crossFn(ema70, ema200);
    if(crossIdx===-1) return null;
    const barsAgo = ema70.length-1-crossIdx;
    if(barsAgo>recentLimit) return null;

    const isBullish = mode.includes("bullish");
    const valid = isBullish
      ? (ema14[last]>ema70[last] && ema70[last]>ema200[last])
      : (ema14[last]<ema70[last] && ema70[last]<ema200[last]);
    if(!valid) return null;

    return {
      symbol, change,
      e14: ema14[last].toFixed(2),
      e70: ema70[last].toFixed(2),
      e200: ema200[last].toFixed(2),
      barsAgo, mode
    };
  }catch{return null;}
}

function disableButtons(state){
  document.querySelectorAll("button").forEach(btn=>btn.disabled=state);
}

function updateProgress(percent){
  document.getElementById("progress-bar").style.width = `${Math.min(100,percent)}%`;
}

// === Auto-refresh system ===
function startAutoRefresh(mode) {
  if (autoRefreshTimer) clearInterval(autoRefreshTimer);
  autoRefreshTimer = setInterval(() => {
    console.log(`üîÅ Auto-refreshing ${mode} scan...`);
    startScan(mode, true);
  }, autoRefreshInterval);
}

// === Main scanner ===
async function startScan(mode, auto = false){
  if(isScanning){
    if(!auto) alert("‚ö†Ô∏è Scan already running. Wait...");
    return;
  }

  const now = Date.now();
  if(!auto && (now - lastScanTime < cooldownMs)){
    return alert(`‚è≥ Wait ${(cooldownMs - (now - lastScanTime))/1000|0}s before rescanning.`);
  }

  isScanning = true;
  lastScanTime = now;
  disableButtons(true);
  updateProgress(0);

  const resultsEl = document.getElementById("results");
  const txt = document.getElementById("progressText");
  resultsEl.innerHTML = "";
  document.getElementById("foundCount").textContent = 0;

  txt.textContent = auto ? "Auto-refreshing..." : "Fetching 24h tickers...";
  const tickers = await get24hSymbols();
  const filtered = tickers.filter(t=>{
    if(!t.symbol.endsWith("USDT")) return false;
    if(mode.includes("green")) return t.change>0;
    if(mode.includes("red")) return t.change<0;
    return false;
  });

  txt.textContent = `Scanning ${filtered.length} pairs...`;

  let found = 0;
  for(let i=0;i<filtered.length;i+=concurrency){
    const batch = filtered.slice(i,i+concurrency);
    const res = await Promise.all(batch.map(s=>processSymbol(s,mode)));
    res.forEach(r=>{
      if(!r) return;
      found++;
      document.getElementById("foundCount").textContent = found;
      const row = `<tr>
        <td>${r.symbol}</td>
        <td style="color:${r.change>0?"#00ff88":"#ff5555"}">${r.change.toFixed(2)}%</td>
        <td>${r.e14}</td><td>${r.e70}</td><td>${r.e200}</td>
        <td class="${r.mode.includes("bullish")?'ok':'bear'}">
          ${r.mode.includes("bullish")?'‚úÖ Bullish':'‚ö†Ô∏è Bearish'} (${r.barsAgo} candles ago)
        </td>
      </tr>`;
      resultsEl.insertAdjacentHTML("beforeend", row);
    });
    updateProgress((i+concurrency)/filtered.length*100);
    await sleep(delayMs);
  }

  txt.textContent = `‚úÖ ${auto ? "Auto-update complete" : "Scan complete"}. Found ${found} crosses.`;
  disableButtons(false);
  isScanning = false;

  if(!auto) startAutoRefresh(mode); // ‚úÖ enable auto-update after first manual scan
}

// === UI bindings ===
document.getElementById("greenBullish").onclick=()=>startScan("green_bullish");
document.getElementById("redBullish").onclick=()=>startScan("red_bullish");
document.getElementById("greenBearish").onclick=()=>startScan("green_bearish");
document.getElementById("redBearish").onclick=()=>startScan("red_bearish");

// === preload counters ===
preloadCounts();
setInterval(preloadCounts, 60000); // update green/red counts every 60 s
      </script>
</body>
</html>
