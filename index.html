<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Binance Futures — Green 24h + EMA70/200 Bullish Cross Detector</title>
<style>
  body { font-family: Arial, sans-serif; background: #0d1117; color: #eee; text-align: center; }
  h1 { color: #f1c40f; }
  table { margin: 20px auto; border-collapse: collapse; width: 90%; }
  th, td { padding: 8px 12px; border: 1px solid #333; }
  tr:nth-child(even) { background: #1a1f29; }
  tr:nth-child(odd) { background: #161b22; }
  .ok { color: #00ff88; font-weight: bold; }
  .warn { color: #ffcc00; }
  #progress { margin-top: 10px; }
</style>
</head>
<body>
<h1>Binance Futures EMA70/200 Bullish Cross Detector</h1>
<p>Stage 1: Show all <span class="ok">green 24h change</span> pairs<br>
Stage 2: Check only those for <span class="warn">EMA70/200 bullish cross (15m)</span></p>
<button id="startBtn">Start Scan</button>
<div id="progress"></div>
<table>
  <thead>
    <tr>
      <th>Pair</th>
      <th>24h Change</th>
      <th>EMA70</th>
      <th>EMA200</th>
      <th>Status</th>
    </tr>
  </thead>
  <tbody id="results"></tbody>
</table>

<script>
const apiBase = "https://fapi.binance.com";
const tf = "15m";
const candlesLimit = 200;
const concurrency = 5; // safe concurrency limit

function ema(values, period) {
  const k = 2 / (period + 1);
  let emaArray = [values[0]];
  for (let i = 1; i < values.length; i++) {
    emaArray.push(values[i] * k + emaArray[i - 1] * (1 - k));
  }
  return emaArray;
}

function checkRecentBullishCross(ema70, ema200) {
  const len = ema70.length;
  const lookback = 25;
  for (let i = len - lookback; i < len; i++) {
    if (ema70[i - 1] < ema200[i - 1] && ema70[i] > ema200[i]) return true;
  }
  return false;
}

async function fetchCandles(symbol) {
  const url = `${apiBase}/fapi/v1/klines?symbol=${symbol}&interval=${tf}&limit=${candlesLimit}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error(`Error fetching ${symbol}`);
  const data = await res.json();
  return data.map(c => parseFloat(c[4]));
}

async function getAllSymbols() {
  const res = await fetch(`${apiBase}/fapi/v1/exchangeInfo`);
  const data = await res.json();
  return data.symbols
    .filter(s => s.contractType === "PERPETUAL" && s.symbol.endsWith("USDT"))
    .map(s => s.symbol);
}

async function getGreenSymbols() {
  const res = await fetch(`${apiBase}/fapi/v1/ticker/24hr`);
  const data = await res.json();
  return data
    .filter(t => t.symbol.endsWith("USDT") && parseFloat(t.priceChangePercent) > 0)
    .sort((a, b) => parseFloat(b.priceChangePercent) - parseFloat(a.priceChangePercent))
    .map(t => ({
      symbol: t.symbol,
      change: parseFloat(t.priceChangePercent)
    }));
}

async function displayGreenList(greenList) {
  const tbody = document.getElementById("results");
  tbody.innerHTML = "";
  for (const g of greenList) {
    const row = `<tr id="${g.symbol}">
      <td>${g.symbol}</td>
      <td style="color:#00ff88;">${g.change.toFixed(2)}%</td>
      <td>-</td><td>-</td>
      <td class="warn">Waiting for EMA check...</td>
    </tr>`;
    tbody.insertAdjacentHTML("beforeend", row);
  }
}

async function processSymbol(symObj) {
  const { symbol } = symObj;
  try {
    const closes = await fetchCandles(symbol);
    const ema70 = ema(closes, 70);
    const ema200 = ema(closes, 200);
    const e70 = ema70.at(-1);
    const e200 = ema200.at(-1);
    const recentCross = checkRecentBullishCross(ema70, ema200);
    const row = document.getElementById(symbol);

    if (recentCross && e70 > e200) {
      row.children[2].innerText = e70.toFixed(2);
      row.children[3].innerText = e200.toFixed(2);
      row.children[4].innerHTML = `<span class="ok">✅ Bullish Cross</span>`;
    } else {
      row.children[2].innerText = e70.toFixed(2);
      row.children[3].innerText = e200.toFixed(2);
      row.children[4].innerText = "—";
    }
  } catch (err) {
    console.warn("Error on", symbol, err.message);
  }
}

async function startScan() {
  document.getElementById("results").innerHTML = "";
  const progress = document.getElementById("progress");
  progress.innerText = "Fetching 24h green pairs...";
  
  const allSymbols = await getAllSymbols();
  const greenList = await getGreenSymbols();
  const greenSymbols = greenList.filter(g => allSymbols.includes(g.symbol));

  progress.innerHTML = `<span class="warn">Found ${greenSymbols.length} green perpetual pairs.</span>`;
  await displayGreenList(greenSymbols);

  progress.innerHTML += `<br>Starting EMA70/200 bullish cross detection...`;

  // --- Concurrent scanning (safe rate-limit) ---
  let index = 0;
  const batch = async () => {
    const tasks = [];
    for (let i = 0; i < concurrency && index < greenSymbols.length; i++, index++) {
      tasks.push(processSymbol(greenSymbols[index]));
    }
    await Promise.all(tasks);
    if (index < greenSymbols.length) await batch();
  };
  await batch();

  progress.innerHTML += `<br><span class="ok">✅ Scan complete.</span>`;
}

document.getElementById("startBtn").addEventListener("click", startScan);
</script>
</body>
</html>
