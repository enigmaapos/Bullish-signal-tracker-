<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Binance Futures EMA Cross Detector</title>
<style>
  body { font-family: Arial, sans-serif; background: #0d1117; color: #eee; text-align: center; }
  h1 { color: #f1c40f; margin-bottom: 10px; }
  p { color: #ccc; margin-top: 0; }
  table { margin: 20px auto; border-collapse: collapse; width: 95%; }
  th, td { padding: 8px 12px; border: 1px solid #333; font-size: 13px; }
  tr:nth-child(even) { background: #1a1f29; }
  tr:nth-child(odd) { background: #161b22; }
  .ok { color: #00ff88; font-weight: bold; }
  .bear { color: #ff5555; font-weight: bold; }
  .warn { color: #ffcc00; }
  button { background: #f1c40f; color: #000; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin: 5px; }
  button:disabled { background: #555; color: #999; cursor: not-allowed; }
  #progress, #count { margin-top: 10px; font-weight: bold; }
</style>
</head>
<body>
<h1>Binance Futures EMA Cross Detector</h1>
<p>Timeframe: 15m | Safe: 5 pairs/sec | Candles: 200 | Cooldown: 30s</p>

<div>
  <button id="greenBullish">üü¢ Green Bullish</button>
  <button id="redBullish">üî¥ Red Bullish</button>
  <button id="greenBearish">üü¢ Green Bearish</button>
  <button id="redBearish">üî¥ Red Bearish</button>
</div>

<div id="progress"></div>
<div id="count"></div>

<table>
  <thead>
    <tr>
      <th>Pair</th>
      <th>24h Change %</th>
      <th>EMA14</th>
      <th>EMA70</th>
      <th>EMA200</th>
      <th>Status</th>
    </tr>
  </thead>
  <tbody id="results"></tbody>
</table>

<script>
const apiBase = "https://fapi.binance.com";
const tf = "15m";
const candlesLimit = 200;
const concurrency = 5;
const delayMs = 1000;
const recentLimit = 25;
const cooldownMs = 30000;
let isScanning = false;
let lastScanTime = 0;

async function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

function ema(values, period){
  const k = 2 / (period + 1);
  let emaArr = [values[0]];
  for(let i=1;i<values.length;i++)
    emaArr.push(values[i]*k + emaArr[i-1]*(1-k));
  return emaArr;
}

// Detect bullish cross (EMA70 crosses ABOVE EMA200)
function findBullishCross(ema70, ema200){
  for(let i=1;i<ema70.length;i++){
    if(ema70[i-1]<ema200[i-1] && ema70[i]>=ema200[i]) return i;
  }
  return -1;
}

// Detect bearish cross (EMA70 crosses BELOW EMA200)
function findBearishCross(ema70, ema200){
  for(let i=1;i<ema70.length;i++){
    if(ema70[i-1]>ema200[i-1] && ema70[i]<=ema200[i]) return i;
  }
  return -1;
}

async function fetchCandles(symbol){
  const url = `${apiBase}/fapi/v1/klines?symbol=${symbol}&interval=${tf}&limit=${candlesLimit}`;
  const res = await fetch(url);
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  const data = await res.json();
  return data.map(c=>parseFloat(c[4]));
}

async function getAllSymbols(){
  const res = await fetch(`${apiBase}/fapi/v1/exchangeInfo`);
  const data = await res.json();
  return data.symbols
    .filter(s=>s.contractType==="PERPETUAL" && s.symbol.endsWith("USDT"))
    .map(s=>s.symbol);
}

async function get24hSymbols(){
  const res = await fetch(`${apiBase}/fapi/v1/ticker/24hr`);
  const data = await res.json();
  return data.map(t=>({
    symbol: t.symbol,
    change: parseFloat(t.priceChangePercent)
  }));
}

async function processSymbol({symbol, change}, mode){
  try{
    const closes = await fetchCandles(symbol);
    const ema14 = ema(closes,14);
    const ema70 = ema(closes,70);
    const ema200 = ema(closes,200);
    const last = ema14.length - 1;
    const crossFn = mode.includes("bullish") ? findBullishCross : findBearishCross;
    const crossIdx = crossFn(ema70, ema200);
    if(crossIdx===-1) return null;
    const barsAgo = ema70.length-1-crossIdx;
    if(barsAgo>recentLimit) return null;

    const isBullish = mode.includes("bullish");
    const valid = isBullish
      ? (ema14[last]>ema70[last] && ema70[last]>ema200[last])
      : (ema14[last]<ema70[last] && ema70[last]<ema200[last]);
    if(!valid) return null;

    return {
      symbol,
      change,
      e14: ema14[last].toFixed(2),
      e70: ema70[last].toFixed(2),
      e200: ema200[last].toFixed(2),
      barsAgo,
      mode
    };
  }catch(e){
    console.warn("Error:", symbol, e.message);
    return null;
  }
}

async function startScan(mode){
  if(isScanning){
    alert("‚ö†Ô∏è A scan is already running. Please wait.");
    return;
  }
  const now = Date.now();
  if(now-lastScanTime<cooldownMs){
    alert(`‚è≥ Please wait ${(cooldownMs-(now-lastScanTime))/1000|0}s before rescanning.`);
    return;
  }
  lastScanTime = now;
  isScanning = true;

  const progress = document.getElementById("progress");
  const count = document.getElementById("count");
  const results = document.getElementById("results");
  results.innerHTML = "";
  progress.innerText = "Fetching symbols...";
  count.innerText = "";

  const [allSymbols, tickers] = await Promise.all([getAllSymbols(), get24hSymbols()]);
  const filtered = tickers.filter(t=>{
    if(!allSymbols.includes(t.symbol) || !t.symbol.endsWith("USDT")) return false;
    if(mode.includes("green")) return t.change>0;
    if(mode.includes("red")) return t.change<0;
    return false;
  });

  count.innerHTML = `${mode.includes("green")?"üü¢":"üî¥"} Found <span class="ok">${filtered.length}</span> matching pairs`;
  progress.innerText = "Scanning EMA crosses...";

  let found=0, index=0;
  while(index<filtered.length){
    const batch = filtered.slice(index, index+concurrency);
    const batchResults = await Promise.all(batch.map(s=>processSymbol(s,mode)));
    batchResults.forEach(r=>{
      if(!r) return;
      found++;
      const isBull = r.mode.includes("bullish");
      const row = `<tr>
        <td>${r.symbol}</td>
        <td style="color:${r.change>0?"#00ff88":"#ff5555"};">${r.change.toFixed(2)}%</td>
        <td>${r.e14}</td>
        <td>${r.e70}</td>
        <td>${r.e200}</td>
        <td class="${isBull?'ok':'bear'}">${isBull?'‚úÖ Bullish':'‚ö†Ô∏è Bearish'} Cross (${r.barsAgo} candles ago)</td>
      </tr>`;
      results.insertAdjacentHTML("beforeend",row);
    });
    index+=concurrency;
    progress.innerText = `Progress: ${Math.min(index, filtered.length)}/${filtered.length}`;
    await sleep(delayMs);
  }

  progress.innerHTML = `<span class="ok">‚úÖ Scan complete. Found ${found} ${mode.includes("bullish")?'bullish':'bearish'} crosses.</span>`;
  isScanning=false;
}

document.getElementById("greenBullish").onclick=()=>startScan("green_bullish");
document.getElementById("redBullish").onclick=()=>startScan("red_bullish");
document.getElementById("greenBearish").onclick=()=>startScan("green_bearish");
document.getElementById("redBearish").onclick=()=>startScan("red_bearish");
</script>
</body>
</html>
