<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EMA Wick Detector (Batch 1D, PH Time)</title>
  <style>
    body {font-family: Inter, sans-serif; background: #0f172a; color: #f1f5f9; margin: 0; padding: 20px;}
    h1 {color: #38bdf8;}
    button {background: #38bdf8; color: #0f172a; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold;}
    button:hover {background: #0ea5e9;}
    #progress {margin-top: 10px; font-size: 14px; color: #94a3b8;}
    #bar {height: 10px; background: #334155; border-radius: 5px; margin-top: 5px; overflow: hidden;}
    #bar-inner {height: 100%; width: 0%; background: #38bdf8; transition: width 0.3s ease;}
    #results {margin-top: 20px; white-space: pre-wrap; background: #1e293b; padding: 15px; border-radius: 10px;}
    #timezone {color: #a3e635; margin-top: 10px; font-size: 14px;}
  </style>
</head>
<body>
  <h1>ðŸ“Š EMA Wick Detector (1D Batch Mode) â€“ Binance Futures</h1>
  <p>Detects candles whose wick is entirely inside EMA14 and EMA70.<br>Scans all Binance USDT perpetual pairs in batches of 10 (PH Time).</p>
  <div id="timezone">ðŸ•’ Philippine Standard Time (UTC+8)</div>
  <button id="startScan">Run Market Scan (Batch Mode)</button>
  <div id="progress">Progress: Not started</div>
  <div id="bar"><div id="bar-inner"></div></div>
  <div id="results"></div>

  <script>
    const delay = ms => new Promise(res => setTimeout(res, ms));
    const maxCandles = 200;
    const batchSize = 10; // 10 pairs per batch
    const batchDelay = 1500; // ms between batches

    async function fetchSymbols() {
      const res = await fetch('https://fapi.binance.com/fapi/v1/exchangeInfo');
      const data = await res.json();
      return data.symbols
        .filter(s => s.symbol.endsWith('USDT') && s.contractType === 'PERPETUAL')
        .map(s => s.symbol);
    }

    async function fetchKlines(symbol) {
      const url = `https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=1d&limit=${maxCandles}`;
      const res = await fetch(url);
      return await res.json();
    }

    function ema(values, period) {
      const k = 2 / (period + 1);
      const emaArray = [values[0]];
      for (let i = 1; i < values.length; i++) {
        emaArray.push(values[i] * k + emaArray[i - 1] * (1 - k));
      }
      return emaArray;
    }

    async function detectInsideWick(symbol) {
      const klines = await fetchKlines(symbol);
      const closes = klines.map(k => parseFloat(k[4]));
      const highs = klines.map(k => parseFloat(k[2]));
      const lows = klines.map(k => parseFloat(k[3]));
      const ema14 = ema(closes, 14);
      const ema70 = ema(closes, 70);
      let matches = [];

      for (let i = Math.max(70, 14); i < closes.length; i++) {
        const high = highs[i], low = lows[i];
        const e14 = ema14[i], e70 = ema70[i];
        const t = new Date(klines[i][0]);
        t.setHours(t.getHours() + 8); // Convert to Philippine time
        const timePH = t.toISOString().replace('T', ' ').split('.')[0];
        const upper = Math.max(e14, e70), lower = Math.min(e14, e70);
        if (high <= upper && low >= lower) {
          matches.push(`${symbol} | ${timePH} | Wick inside EMA14 & EMA70`);
        }
      }
      return matches;
    }

    async function runScan() {
      document.getElementById('progress').textContent = 'Fetching symbols...';
      const symbols = await fetchSymbols();
      const results = [];
      const total = symbols.length;
      let completed = 0;

      for (let i = 0; i < symbols.length; i += batchSize) {
        const batch = symbols.slice(i, i + batchSize);
        document.getElementById('progress').textContent = `Scanning batch ${Math.ceil(i/batchSize)+1} of ${Math.ceil(total/batchSize)}...`;

        const promises = batch.map(async symbol => {
          try {
            const found = await detectInsideWick(symbol);
            if (found.length) results.push(...found);
          } catch (e) {
            console.error('Error on', symbol, e);
          } finally {
            completed++;
            const percent = ((completed / total) * 100).toFixed(1);
            document.getElementById('progress').textContent = `Progress: ${completed}/${total} (${percent}%)`;
            document.getElementById('bar-inner').style.width = `${percent}%`;
          }
        });

        await Promise.all(promises);
        await delay(batchDelay);
      }

      document.getElementById('progress').textContent = 'âœ… Scan complete';
      const output = results.length ? results.join('\n') : 'No inside wick candles found.';
      document.getElementById('results').textContent = output;

      // Save to text file
      const blob = new Blob([output], { type: 'text/plain' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'ema_wick_results_batch_PHtime.txt';
      a.click();
    }

    document.getElementById('startScan').addEventListener('click', runScan);
  </script>
</body>
</html>
