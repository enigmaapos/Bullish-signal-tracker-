<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Binance Futures EMA14 > EMA70 > EMA200 Bullish Cross Detector</title>
<style>
  body { font-family: Arial, sans-serif; background: #0d1117; color: #eee; text-align: center; }
  h1 { color: #f1c40f; }
  table { margin: 20px auto; border-collapse: collapse; width: 95%; }
  th, td { padding: 8px 12px; border: 1px solid #333; font-size: 13px; }
  tr:nth-child(even) { background: #1a1f29; }
  tr:nth-child(odd) { background: #161b22; }
  .ok { color: #00ff88; font-weight: bold; }
  .warn { color: #ffcc00; }
  .err { color: #ff5555; }
  #progress, #count { margin-top: 10px; font-weight: bold; }
  button { background: #f1c40f; color: #000; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
  button:disabled { background: #555; color: #999; cursor: not-allowed; }
</style>
</head>
<body>
<h1>Binance Futures EMA14 > EMA70 > EMA200 Bullish Cross Detector</h1>
<p>Timeframe: 15m | Safe: 5 pairs/sec | Candles: 200 | Cooldown: 30s</p>
<button id="startBtn">Start Scan</button>
<div id="progress"></div>
<div id="count"></div>

<table>
  <thead>
    <tr>
      <th>Pair</th>
      <th>24h Change %</th>
      <th>EMA14</th>
      <th>EMA70</th>
      <th>EMA200</th>
      <th>Status</th>
    </tr>
  </thead>
  <tbody id="results"></tbody>
</table>

<script>
const apiBase = "https://fapi.binance.com";
const tf = "15m";
const candlesLimit = 200;
const concurrency = 5;         // parallel requests per batch
const delayMs = 1000;          // 1s delay between batches
const recentLimit = 25;        // must cross within 25 candles
const cooldownMs = 30000;      // 30s cooldown protection
let lastScanTime = 0;

async function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

function ema(values, period) {
  const k = 2 / (period + 1);
  let emaArr = [values[0]];
  for (let i = 1; i < values.length; i++)
    emaArr.push(values[i] * k + emaArr[i - 1] * (1 - k));
  return emaArr;
}

// detect first bullish cross of EMA70>EMA200
function findBullishCross(ema70, ema200) {
  for (let i = 1; i < ema70.length; i++) {
    if (ema70[i - 1] < ema200[i - 1] && ema70[i] >= ema200[i]) return i;
  }
  return -1;
}

async function fetchCandles(symbol) {
  const url = `${apiBase}/fapi/v1/klines?symbol=${symbol}&interval=${tf}&limit=${candlesLimit}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  const data = await res.json();
  return data.map(c => parseFloat(c[4]));
}

async function getAllSymbols() {
  const res = await fetch(`${apiBase}/fapi/v1/exchangeInfo`);
  const data = await res.json();
  return data.symbols
    .filter(s => s.contractType === "PERPETUAL" && s.symbol.endsWith("USDT"))
    .map(s => s.symbol);
}

async function getGreenSymbols() {
  const res = await fetch(`${apiBase}/fapi/v1/ticker/24hr`);
  const data = await res.json();
  return data
    .filter(t => t.symbol.endsWith("USDT") && parseFloat(t.priceChangePercent) > 0)
    .map(t => ({
      symbol: t.symbol,
      change: parseFloat(t.priceChangePercent)
    }));
}

async function processSymbol({symbol, change}) {
  try {
    const closes = await fetchCandles(symbol);
    const ema14 = ema(closes, 14);
    const ema70 = ema(closes, 70);
    const ema200 = ema(closes, 200);

    const crossIdx = findBullishCross(ema70, ema200);
    if (crossIdx === -1) return null; // no cross
    const barsAgo = ema70.length - 1 - crossIdx;
    if (barsAgo > recentLimit) return null; // too old

    // confirm structure EMA14 > EMA70 > EMA200 after cross
    const last = ema14.length - 1;
    if (!(ema14[last] > ema70[last] && ema70[last] > ema200[last])) return null;

    return {
      symbol,
      change,
      e14: ema14[last].toFixed(2),
      e70: ema70[last].toFixed(2),
      e200: ema200[last].toFixed(2),
      barsAgo
    };
  } catch (e) {
    console.warn("Error:", symbol, e.message);
    return null;
  }
}

async function startScan() {
  const now = Date.now();
  if (now - lastScanTime < cooldownMs) {
    alert(`⏳ Please wait ${(cooldownMs - (now - lastScanTime))/1000|0}s before rescanning.`);
    return;
  }
  lastScanTime = now;

  const btn = document.getElementById("startBtn");
  const progress = document.getElementById("progress");
  const count = document.getElementById("count");
  const results = document.getElementById("results");
  btn.disabled = true;
  results.innerHTML = "";
  progress.innerText = "Fetching green pairs...";

  const [allSymbols, greenList] = await Promise.all([getAllSymbols(), getGreenSymbols()]);
  const greenSymbols = greenList.filter(g => allSymbols.includes(g.symbol));
  count.innerHTML = `🟢 Found <span class="ok">${greenSymbols.length}</span> green USDT perpetual pairs`;

  progress.innerText = "Scanning EMA crosses...";
  let found = 0;
  let index = 0;

  while (index < greenSymbols.length) {
    const batch = greenSymbols.slice(index, index + concurrency);
    const resultsBatch = await Promise.all(batch.map(processSymbol));

    resultsBatch.forEach(res => {
      if (!res) return;
      found++;
      const row = `<tr>
        <td>${res.symbol}</td>
        <td style="color:#00ff88;">${res.change.toFixed(2)}%</td>
        <td>${res.e14}</td>
        <td>${res.e70}</td>
        <td>${res.e200}</td>
        <td class="ok">✅ Bullish Cross (${res.barsAgo} candles ago)</td>
      </tr>`;
      results.insertAdjacentHTML("beforeend", row);
    });

    index += concurrency;
    progress.innerText = `Progress: ${Math.min(index, greenSymbols.length)}/${greenSymbols.length}`;
    await sleep(delayMs); // rate safety
  }

  progress.innerHTML = `<span class="ok">✅ Scan complete. Found ${found} bullish crosses.</span>`;
  btn.disabled = false;
}

document.getElementById("startBtn").addEventListener("click", startScan);
</script>
</body>
</html>
