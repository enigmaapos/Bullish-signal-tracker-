<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Binance Futures EMA Cross Detector</title>
<style>
  :root {
    --bg: #0e1117;
    --card: #161b22;
    --border: #2b313b;
    --accent: #f1c40f;
    --bull: #00ff88;
    --bear: #ff5555;
  }

  * {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    font-family: "Segoe UI", Arial, sans-serif;
    background: var(--bg);
    color: #e0e0e0;
    overflow-x: hidden; /* ✅ prevent horizontal scroll */
  }

  h1 {
    color: var(--accent);
    margin: 20px 10px 5px;
    text-align: center;
    font-size: clamp(1.2rem, 4vw, 1.8rem); /* ✅ scales title */
  }

  p {
    text-align: center;
    color: #aaa;
    margin: 0 10px 20px;
    font-size: clamp(0.8rem, 3vw, 1rem);
  }

  .controls {
    text-align: center;
    margin-bottom: 10px;
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 8px;
    padding: 0 10px;
  }

  button {
    background: var(--accent);
    color: #000;
    font-weight: bold;
    padding: 10px 14px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: clamp(0.8rem, 3vw, 1rem);
  }

  button:hover:not(:disabled) {
    transform: scale(1.03);
    box-shadow: 0 0 8px var(--accent);
  }

  button:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }

  .dashboard {
    width: 100%;
    max-width: 1200px;
    margin: auto;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 0 15px rgba(0,0,0,0.4);
  }

  .stats {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    margin: 10px 0;
    gap: 10px;
  }

  .stat-box {
    background: #1b222d;
    border-radius: 10px;
    padding: 10px 15px;
    text-align: center;
    min-width: 110px;
    font-size: 0.9rem;
  }

  .stat-box span {
    display: block;
    font-size: 1.4rem;
    font-weight: bold;
  }

  #progress-container {
    width: 100%;
    height: 10px;
    background: #2b2b2b;
    border-radius: 6px;
    overflow: hidden;
    margin: 10px 0;
  }

  #progress-bar {
    width: 0%;
    height: 100%;
    background: var(--accent);
    transition: width 0.3s;
  }

  .table-container {
    width: 100%;
    overflow-x: auto; /* ✅ scroll horizontally if needed */
  }

  table {
    width: 100%;
    min-width: 600px; /* ✅ ensures table scrolls on mobile */
    border-collapse: collapse;
    margin-top: 15px;
  }

  th, td {
    padding: 8px;
    border-bottom: 1px solid #2b2b2b;
    text-align: center;
    font-size: 13px;
    white-space: nowrap;
  }

  th {
    color: var(--accent);
    background: #1e2530;
  }

  tr:nth-child(even) { background: #141a22; }
  tr:nth-child(odd) { background: #10151c; }

  .ok { color: var(--bull); font-weight: bold; }
  .bear { color: var(--bear); font-weight: bold; }

  @media (max-width: 700px) {
    th, td { padding: 6px; font-size: 12px; }
  }
</style>
</head>
<body>
  <h1>Binance Futures EMA Cross Detector</h1>
  <p>Timeframe: 15m • Safe: 5 pairs/sec • Candles: 200 • Cooldown: 30s</p>

  <div class="controls">
    <button id="greenBullish">🟢 Green Bullish</button>
    <button id="redBullish">🔴 Red Bullish</button>
    <button id="greenBearish">🟢 Green Bearish</button>
    <button id="redBearish">🔴 Red Bearish</button>
  </div>

  <div class="dashboard">
    <div class="stats">
      <div class="stat-box" style="color:var(--bull)">
        Green Pairs <span id="greenCount">-</span>
      </div>
      <div class="stat-box" style="color:var(--bear)">
        Red Pairs <span id="redCount">-</span>
      </div>
      <div class="stat-box" style="color:var(--accent)">
        Found Crosses <span id="foundCount">0</span>
      </div>
    </div>

    <div id="progress-container"><div id="progress-bar"></div></div>
    <div id="progressText" style="text-align:center; margin-bottom:10px;"></div>

    <div class="table-container">
    <table>
  <thead>
    <tr>
      <th>Pair</th>
      <th>24h Change %</th>
      <th>Funding</th>
      <th>EMA70</th>
      <th>EMA200</th>
      <th>RSI Now</th>
      <th>Cross Type</th>
      <th>Cross Time</th>
      <th>Bars Ago</th>
    </tr>
  </thead>
  <tbody id="results"></tbody>
</table>
  </div>
  </div>

           <script>
const apiBase = "https://fapi.binance.com";
const tf = "15m";
const candlesLimit = 500;
const concurrency = 10;
const delayMs = 1000;
const cooldownMs = 30000;
const batchSize = 20; // refresh batch size
const batchRefreshDelay = 10000; // 10s between batch refreshes

let isScanning = false;
let lastScanTime = 0;
let autoRefreshTimer = null;
let allSymbols = [];
let refreshIndex = 0;

async function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

function ema(values, period){
  const k = 2 / (period + 1);
  const emaArr = [values[0]];
  for(let i=1;i<values.length;i++){
    emaArr.push(values[i]*k + emaArr[i-1]*(1-k));
  }
  return emaArr;
}

async function fetchCandles(symbol){
  const res = await fetch(`${apiBase}/fapi/v1/klines?symbol=${symbol}&interval=${tf}&limit=${candlesLimit}`);
  const data = await res.json();
  return data.map(c=>({
    time: c[0],
    open: parseFloat(c[1]),
    close: parseFloat(c[4]),
    volume: parseFloat(c[5])
  }));
}

async function get24hSymbols(){
  const res = await fetch(`${apiBase}/fapi/v1/ticker/24hr`);
  const data = await res.json();
  return data.map(t=>({
    symbol: t.symbol,
    change: parseFloat(t.priceChangePercent)
  }));
}

async function preloadCounts(){
  const tickers = await get24hSymbols();
  const greens = tickers.filter(t=>t.change>0 && t.symbol.endsWith("USDT")).length;
  const reds = tickers.filter(t=>t.change<0 && t.symbol.endsWith("USDT")).length;
  document.getElementById("greenCount").textContent = greens;
  document.getElementById("redCount").textContent = reds;
}

function calcRSI(closes, period = 14){
  let gains = 0, losses = 0;
  for(let i=1;i<=period;i++){
    const diff = closes[i]-closes[i-1];
    if(diff>=0) gains+=diff; else losses-=diff;
  }
  let avgGain = gains/period;
  let avgLoss = losses/period;
  const rsiArr = [];
  for(let i=period;i<closes.length;i++){
    const diff = closes[i]-closes[i-1];
    const gain = Math.max(0,diff);
    const loss = Math.max(0,-diff);
    avgGain = (avgGain*(period-1)+gain)/period;
    avgLoss = (avgLoss*(period-1)+loss)/period;
    const rs = avgLoss===0 ? 100 : 100 - 100/(1+avgGain/avgLoss);
    rsiArr.push(rs);
  }
  while(rsiArr.length < closes.length) rsiArr.unshift(rsiArr[0] || 50);
  return rsiArr;
}

// ✅ Fetch recent funding rate (Binance Futures)
async function fetchFundingRate(symbol) {
  try {
    const res = await fetch(`${apiBase}/fapi/v1/fundingRate?symbol=${symbol}&limit=1`);
    const data = await res.json();
    return parseFloat(data?.[0]?.fundingRate ?? 0);
  } catch (err) {
    console.warn(`Funding fetch failed for ${symbol}:`, err.message);
    return 0;
  }
}

async function processSymbol({ symbol, change }, mode) {
  try {
    // === Basic Filters ===
    if (mode.includes("bullish") && change < 0) return null;
    if (mode.includes("bearish") && change > 0) return null;

    // ✅ Must have positive funding
    const funding = await fetchFundingRate(symbol);
    if (funding <= 0) return null;

    // ✅ Must have ≥ 10% 24h price change
    if (Math.abs(change) < 10) return null;

    // === Load Candles ===
    const candles = await fetchCandles(symbol);
    if (!candles || candles.length < 100) return null;

    // Only use last 100 candles
    const recentCandles = candles.slice(-100);
    const closes = recentCandles.map(c => c.close);

    const ema70 = ema(closes, 70);
    const ema200 = ema(closes, 200);
    const last = ema70.length - 1;
    const isBullish = mode.includes("bullish");

    // === Detect EMA Cross ===
    let crossIdx = -1;
    for (let i = ema70.length - 2; i >= 0; i--) {
      const prev70 = ema70[i], curr70 = ema70[i + 1];
      const prev200 = ema200[i], curr200 = ema200[i + 1];
      const crossedUp = prev70 < prev200 && curr70 > curr200;
      const crossedDown = prev70 > prev200 && curr70 < curr200;
      if (isBullish && crossedUp) { crossIdx = i + 1; break; }
      else if (!isBullish && crossedDown) { crossIdx = i + 1; break; }
    }
    if (crossIdx === -1) return null;

    // ✅ Only keep recent crosses (within last 20 candles)
    const barsAgo = ema70.length - 1 - crossIdx;
    if (barsAgo > 20) return null;

    const crossTime = new Date(recentCandles[crossIdx].time)
      .toLocaleTimeString("en-US", { hour12: false });

    // === Return minimal info ===
    return {
      symbol,
      change,
      funding,
      ema70: ema70[last].toFixed(2),
      ema200: ema200[last].toFixed(2),
      crossTime,
      barsAgo,
      crossType: isBullish ? "🟩 EMA70→200 Cross" : "🟥 EMA200→70 Cross"
    };

  } catch (err) {
    console.error(`Error processing ${symbol}:`, err.message);
    return null;
  }
        }

function disableButtons(state){
  document.querySelectorAll("button").forEach(btn=>btn.disabled=state);
}

function updateProgress(percent){
  document.getElementById("progress-bar").style.width = `${Math.min(100,percent)}%`;
}

function sortTableByChange(ascending = false) {
  const tbody = document.getElementById("results");
  const rows = Array.from(tbody.querySelectorAll("tr"));
  rows.sort((a, b) => {
    const valA = parseFloat(a.children[1].textContent.replace('%', ''));
    const valB = parseFloat(b.children[1].textContent.replace('%', ''));
    return ascending ? valA - valB : valB - valA;
  });
  tbody.innerHTML = "";
  rows.forEach(r => tbody.appendChild(r));
}

// 🆕 Incremental batch refresh system
async function refreshBatch(mode) {
  if (!allSymbols.length || isScanning) return;
  isScanning = true;

  const txt = document.getElementById("progressText");
  txt.textContent = `🔄 Refreshing batch ${Math.floor(refreshIndex / batchSize) + 1}...`;

  const batch = allSymbols.slice(refreshIndex, refreshIndex + batchSize);
  const res = await Promise.all(batch.map(s => processSymbol(s, mode)));

  res.forEach(r => {
    if (!r) return;
    let existingRow = document.querySelector(`tr[data-symbol="${r.symbol}"]`);
    if (existingRow) {
      existingRow.innerHTML = `
        <td>${r.symbol}</td>
        <td style="color:${r.change>0?"#00ff88":"#ff5555"}">${r.change.toFixed(2)}%</td>
        <td>${r.funding.toFixed(4)}%</td>
        <td>${r.ema70}</td>
        <td>${r.ema200}</td>
        <td>${r.rsiNow}</td>
        <td>${r.crossType}</td>
        <td>${r.crossTime}</td>
        <td>${r.barsAgo}</td>
      `;
    }
  });

  refreshIndex += batchSize;
  if (refreshIndex >= allSymbols.length) refreshIndex = 0;

  txt.textContent = `✅ Batch refresh done (${refreshIndex}/${allSymbols.length}).`;
  isScanning = false;
}

function startAutoRefresh(mode) {
  if (autoRefreshTimer) clearInterval(autoRefreshTimer);
  autoRefreshTimer = setInterval(() => refreshBatch(mode), batchRefreshDelay);
}

async function startScan(mode, auto=false){
  if(isScanning){
    if(!auto) alert("⚠️ Scan already running. Wait...");
    return;
  }

  const now = Date.now();
  if(!auto && (now - lastScanTime < cooldownMs)){
    return alert(`⏳ Wait ${(cooldownMs - (now - lastScanTime))/1000|0}s before rescanning.`);
  }

  isScanning = true;
  lastScanTime = now;
  disableButtons(true);
  updateProgress(0);

  const resultsEl = document.getElementById("results");
  const txt = document.getElementById("progressText");
  resultsEl.innerHTML = "";
  document.getElementById("foundCount").textContent = 0;

  txt.textContent = auto ? "Auto-refreshing..." : "Fetching 24h tickers...";
  const tickers = await get24hSymbols();
  const filtered = tickers.filter(t=>{
    if(!t.symbol.endsWith("USDT")) return false;
    if(mode.includes("green")) return t.change>0;
    if(mode.includes("red")) return t.change<0;
    return false;
  });

  allSymbols = filtered; // ✅ store for batch refreshes
  refreshIndex = 0;

  txt.textContent = `Scanning ${filtered.length} pairs...`;

  let found = 0;
  for(let i=0;i<filtered.length;i+=concurrency){
    const batch = filtered.slice(i,i+concurrency);
    const res = await Promise.all(batch.map(s=>processSymbol(s,mode)));
    res.forEach(r=>{
      if(!r) return;
      found++;
      document.getElementById("foundCount").textContent = found;
      const row = document.createElement("tr");
      row.setAttribute("data-symbol", r.symbol);
      row.innerHTML = `
        <td>${r.symbol}</td>
        <td style="color:${r.change>0?"#00ff88":"#ff5555"}">${r.change.toFixed(2)}%</td>
        <td>${r.funding.toFixed(4)}%</td>
        <td>${r.ema70}</td>
        <td>${r.ema200}</td>
        <td>${r.rsiNow}</td>
        <td>${r.crossType}</td>
        <td>${r.crossTime}</td>
        <td>${r.barsAgo}</td>
      `;
      resultsEl.appendChild(row);
    });
    updateProgress((i+concurrency)/filtered.length*100);
    await sleep(delayMs);
  }

  sortTableByChange(false);
  txt.textContent = `✅ Scan complete. Found ${found} EMA crosses.`;
  disableButtons(false);
  isScanning = false;

  startAutoRefresh(mode); // start incremental refresh
}

document.getElementById("greenBullish").onclick=()=>startScan("green_bullish");
document.getElementById("redBullish").onclick=()=>startScan("red_bullish");
document.getElementById("greenBearish").onclick=()=>startScan("green_bearish");
document.getElementById("redBearish").onclick=()=>startScan("red_bearish");

preloadCounts();
setInterval(preloadCounts, 60000);
                                                                    </script>
</body>
</html>
