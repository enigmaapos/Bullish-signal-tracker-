<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Binance Futures EMA Detector</title>
<style>
  body { font-family: Arial, sans-serif; background: #0d1117; color: #eee; text-align: center; }
  h1 { color: #f1c40f; }
  table { margin: 20px auto; border-collapse: collapse; width: 90%; }
  th, td { padding: 8px 12px; border: 1px solid #333; }
  tr:nth-child(even) { background: #1a1f29; }
  tr:nth-child(odd) { background: #161b22; }
  .ok { color: #00ff88; font-weight: bold; }
  .warn { color: #ffcc00; }
  #progress { margin-top: 10px; }
</style>
</head>
<body>
<h1>Binance Futures EMA14 > EMA70 > EMA200 Detector</h1>
<p>Timeframe: 15m | Safe rate: 1 request/sec | Candles: 200</p>
<button id="startBtn">Start Scan</button>
<div id="progress"></div>
<table>
  <thead>
    <tr>
      <th>Pair</th>
      <th>EMA14</th>
      <th>EMA70</th>
      <th>EMA200</th>
      <th>Status</th>
    </tr>
  </thead>
  <tbody id="results"></tbody>
</table>

<script>
const apiBase = "https://fapi.binance.com";
const tf = "15m";
const candlesLimit = 200;
const delayMs = 1000; // 1 request/sec = safe rate

async function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

function ema(values, period) {
  const k = 2 / (period + 1);
  let emaArray = [values[0]];
  for (let i = 1; i < values.length; i++) {
    emaArray.push(values[i] * k + emaArray[i - 1] * (1 - k));
  }
  return emaArray;
}

async function fetchCandles(symbol) {
  const url = `${apiBase}/fapi/v1/klines?symbol=${symbol}&interval=${tf}&limit=${candlesLimit}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error(`Error fetching ${symbol}`);
  const data = await res.json();
  return data.map(c => parseFloat(c[4])); // closing prices
}

function isEmaRising(arr) {
  const len = arr.length;
  return arr[len - 1] > arr[len - 2];
}

async function getAllSymbols() {
  const res = await fetch(`${apiBase}/fapi/v1/exchangeInfo`);
  const data = await res.json();
  return data.symbols
    .filter(s => s.contractType === "PERPETUAL" && s.symbol.endsWith("USDT"))
    .map(s => s.symbol);
}

async function startScan() {
  document.getElementById("results").innerHTML = "";
  const progress = document.getElementById("progress");
  const allSymbols = await getAllSymbols();
  let found = 0;
  for (let i = 0; i < allSymbols.length; i++) {
    const sym = allSymbols[i];
    progress.innerText = `Scanning ${i + 1}/${allSymbols.length} - ${sym}`;
    try {
      const closes = await fetchCandles(sym);
      const ema14 = ema(closes, 14);
      const ema70 = ema(closes, 70);
      const ema200 = ema(closes, 200);

      const e14 = ema14.at(-1);
      const e70 = ema70.at(-1);
      const e200 = ema200.at(-1);

      const condition = e14 > e70 && e70 > e200 && isEmaRising(ema14);
      if (condition) {
        found++;
        const row = `<tr>
          <td>${sym}</td>
          <td>${e14.toFixed(2)}</td>
          <td>${e70.toFixed(2)}</td>
          <td>${e200.toFixed(2)}</td>
          <td class="ok">✅ Match</td>
        </tr>`;
        document.getElementById("results").insertAdjacentHTML("beforeend", row);
      }
    } catch (e) {
      console.warn("Error on", sym, e.message);
    }
    await sleep(delayMs); // respect rate limit
  }
  progress.innerHTML = `<span class="warn">Scan complete. Found ${found} matching pairs ✅</span>`;
}

document.getElementById("startBtn").addEventListener("click", startScan);
</script>
</body>
</html>
