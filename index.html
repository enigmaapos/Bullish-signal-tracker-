<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Binance Futures — Robust EMA70/EMA200 Cross Detector</title>
<style>
  body{font-family:Inter,Arial,Helvetica,sans-serif;background:#0d1117;color:#e6eef8}
  h1{color:#f1c40f;text-align:center}
  .meta{ text-align:center;margin-bottom:8px }
  button{display:block;margin:8px auto;padding:8px 12px;border-radius:6px}
  table{width:95%;margin:8px auto;border-collapse:collapse}
  th,td{padding:8px;border:1px solid #23313b;text-align:center;font-size:13px}
  tr:nth-child(even){background:#07121a}
  .ok{color:#00ff88;font-weight:600}
  .warn{color:#ffcc00}
  #progress,#count,#found{ text-align:center;margin:6px 0;font-weight:600 }
  .small{font-size:12px;color:#9fb0c6}
</style>
</head>
<body>
  <h1>Binance Futures — EMA70 > EMA200 Recent Cross (15m)</h1>
  <div class="meta">
    <div class="small">Timeframe: <strong>15m</strong> | Candles: <strong>200</strong> | Cross must be ≤ <strong>25</strong> candles ago and inside last <strong>96</strong> candles (prev+curr 12h windows)</div>
  </div>

  <button id="startBtn">Start Scan</button>
  <div id="progress"></div>
  <div id="count"></div>
  <div id="found"></div>

  <table>
    <thead>
      <tr>
        <th>Pair</th>
        <th>24h %</th>
        <th>EMA70</th>
        <th>EMA200</th>
        <th>Candles Ago</th>
        <th>Cross Time (UTC)</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody id="results"></tbody>
  </table>

    <script>
const apiBase = "https://fapi.binance.com";
const tf = "15m";
const candlesLimit = 200;
const delayMs = 1000; // safe rate: 1 request/sec
const maxPairs = 100; // limit pairs per scan
const SCAN_COOLDOWN_MS = 5 * 60 * 1000; // 5 minutes cooldown
let lastScanTime = 0;
let isScanning = false;

async function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

function ema(values, period) {
  const k = 2 / (period + 1);
  let emaArray = [values[0]];
  for (let i = 1; i < values.length; i++) {
    emaArray.push(values[i] * k + emaArray[i - 1] * (1 - k));
  }
  return emaArray;
}

async function fetchCandles(symbol) {
  const url = `${apiBase}/fapi/v1/klines?symbol=${symbol}&interval=${tf}&limit=${candlesLimit}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error(`Error fetching ${symbol}`);
  const data = await res.json();
  return data.map(c => parseFloat(c[4]));
}

async function getAllSymbols() {
  const res = await fetch(`${apiBase}/fapi/v1/exchangeInfo`);
  const data = await res.json();
  return data.symbols
    .filter(s => s.contractType === "PERPETUAL" && s.symbol.endsWith("USDT"))
    .map(s => s.symbol);
}

async function getGreenSymbols() {
  const res = await fetch(`${apiBase}/fapi/v1/ticker/24hr`);
  const data = await res.json();
  return data
    .filter(t => t.symbol.endsWith("USDT") && parseFloat(t.priceChangePercent) > 0)
    .map(t => ({
      symbol: t.symbol,
      change: parseFloat(t.priceChangePercent)
    }));
}

function findRecentCrossIndex(ema70, ema200) {
  for (let i = ema70.length - 1; i >= 1; i--) {
    const isBull = ema70[i] > ema200[i];
    const wasBull = ema70[i - 1] <= ema200[i - 1];
    if (isBull && wasBull === false) return i;
  }
  return -1;
}

async function startScan() {
  const now = Date.now();
  if (isScanning) {
    alert("⚠️ Scan already in progress. Please wait for it to finish.");
    return;
  }
  if (now - lastScanTime < SCAN_COOLDOWN_MS) {
    const waitMin = Math.ceil((SCAN_COOLDOWN_MS - (now - lastScanTime)) / 60000);
    alert(`⏳ Please wait ${waitMin} minute(s) before next scan.`);
    return;
  }

  isScanning = true;
  lastScanTime = now;
  document.getElementById("startBtn").disabled = true;
  document.getElementById("results").innerHTML = "";
  const progress = document.getElementById("progress");
  const count = document.getElementById("count");

  progress.innerText = "Fetching 24h green pairs...";
  const allSymbols = await getAllSymbols();
  const greenList = await getGreenSymbols();
  let greenSymbols = greenList.filter(g => allSymbols.includes(g.symbol));

  // Shuffle and limit to 100 pairs
  greenSymbols = greenSymbols.sort(() => 0.5 - Math.random()).slice(0, maxPairs);

  count.innerHTML = `🟢 Found <span class="ok">${greenSymbols.length}</span> green USDT perpetual pairs (scanning max ${maxPairs})`;
  progress.innerHTML = `<span class="warn">Starting EMA scan for 100 pairs (safe mode)...</span>`;

  let found = 0;
  for (let i = 0; i < greenSymbols.length; i++) {
    const { symbol, change } = greenSymbols[i];
    progress.innerText = `Scanning ${i + 1}/${greenSymbols.length} - ${symbol}`;

    try {
      const closes = await fetchCandles(symbol);
      const ema70 = ema(closes, 70);
      const ema200 = ema(closes, 200);
      const crossIndex = findRecentCrossIndex(ema70, ema200);

      const candlesSinceCross = ema70.length - crossIndex;
      if (crossIndex !== -1 && candlesSinceCross <= 25) {
        found++;
        const e70 = ema70.at(-1);
        const e200 = ema200.at(-1);

        const row = `<tr>
          <td>${symbol}</td>
          <td style="color:#00ff88;">${change.toFixed(2)}%</td>
          <td>${e70.toFixed(2)}</td>
          <td>${e200.toFixed(2)}</td>
          <td class="ok">✅ Bullish EMA70>EMA200 (${candlesSinceCross} candles ago)</td>
        </tr>`;
        document.getElementById("results").insertAdjacentHTML("beforeend", row);
      }
    } catch (e) {
      console.warn("Error on", symbol, e.message);
    }

    await sleep(delayMs);
  }

  progress.innerHTML = `<span class="ok">✅ Scan complete. Found ${found} pairs with EMA70>EMA200 within last 25 candles.</span>`;
  document.getElementById("startBtn").disabled = false;
  isScanning = false;
}
document.getElementById("startBtn").addEventListener("click", startScan);
    </script>
</body>
</html>
