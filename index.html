<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Binance Futures EMA14 > EMA70 > EMA200 Detector</title>
  <style>
    body { font-family: Arial; background: #0b0b0b; color: #f1f1f1; }
    h2 { color: #00ffae; }
    button { padding: 10px 20px; margin: 10px 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #333; padding: 6px; text-align: center; }
    .bullish { color: #00ff66; }
    .neutral { color: #ccc; }
  </style>
</head>
<body>
  <h2>Binance Futures EMA14 > EMA70 > EMA200 Detector</h2>
  <p>Timeframe: 15m | Safe rate: 1 req/sec | Candles: 200</p>

  <button onclick="startScan()">Start Scan</button>
  <p id="progress"></p>
  <p id="greenCount"></p>

  <table id="results">
    <thead>
      <tr>
        <th>Pair</th>
        <th>EMA14</th>
        <th>EMA70</th>
        <th>EMA200</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
const apiBase = "https://fapi.binance.com";
const tf = "15m";
const candlesLimit = 200;
const delayMs = 1000; // safe rate
const recentCandleLimit = 25; // âœ… crossing must be within 25 candles

async function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

function ema(values, period) {
  const k = 2 / (period + 1);
  let emaArray = [values[0]];
  for (let i = 1; i < values.length; i++) {
    emaArray.push(values[i] * k + emaArray[i - 1] * (1 - k));
  }
  return emaArray;
}

async function fetchCandles(symbol) {
  const url = `${apiBase}/fapi/v1/klines?symbol=${symbol}&interval=${tf}&limit=${candlesLimit}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error(`Error fetching ${symbol}`);
  const data = await res.json();
  return data.map(c => parseFloat(c[4]));
}

async function getAllSymbols() {
  const res = await fetch(`${apiBase}/fapi/v1/exchangeInfo`);
  const data = await res.json();
  return data.symbols
    .filter(s => s.contractType === "PERPETUAL" && s.symbol.endsWith("USDT"))
    .map(s => s.symbol);
}

async function getGreenSymbols() {
  const res = await fetch(`${apiBase}/fapi/v1/ticker/24hr`);
  const data = await res.json();
  return data
    .filter(t => t.symbol.endsWith("USDT") && parseFloat(t.priceChangePercent) > 0)
    .map(t => ({
      symbol: t.symbol,
      change: parseFloat(t.priceChangePercent)
    }));
}

// âœ… Find where EMA14>EMA70>EMA200 started
function findRecentCrossIndex(ema14, ema70, ema200) {
  for (let i = ema14.length - 1; i >= 1; i--) {
    const isBull = ema14[i] > ema70[i] && ema70[i] > ema200[i];
    const wasBull = ema14[i - 1] > ema70[i - 1] && ema70[i - 1] > ema200[i - 1];
    // Find the first time it *turned* bullish
    if (isBull && !wasBull) {
      return i; // index of crossing
    }
  }
  return -1; // never crossed
}

async function startScan() {
  document.getElementById("results").innerHTML = "";
  const progress = document.getElementById("progress");
  const count = document.getElementById("count");

  progress.innerText = "Fetching 24h green pairs...";
  const allSymbols = await getAllSymbols();
  const greenList = await getGreenSymbols();
  const greenSymbols = greenList.filter(g => allSymbols.includes(g.symbol));

  count.innerHTML = `ðŸŸ¢ Found <span class="ok">${greenSymbols.length}</span> green USDT perpetual pairs`;
  progress.innerHTML = `<span class="warn">Starting EMA scan only for green pairs...</span>`;

  let found = 0;
  for (let i = 0; i < greenSymbols.length; i++) {
    const { symbol, change } = greenSymbols[i];
    progress.innerText = `Scanning ${i + 1}/${greenSymbols.length} - ${symbol}`;

    try {
      const closes = await fetchCandles(symbol);
      const ema14 = ema(closes, 14);
      const ema70 = ema(closes, 70);
      const ema200 = ema(closes, 200);

      const crossIndex = findRecentCrossIndex(ema14, ema70, ema200);

      if (crossIndex !== -1 && ema14.length - crossIndex <= recentCandleLimit) {
        // âœ… Recent bullish crossing within last 25 candles
        found++;
        const e14 = ema14.at(-1);
        const e70 = ema70.at(-1);
        const e200 = ema200.at(-1);

        const row = `<tr>
          <td>${symbol}</td>
          <td style="color:#00ff88;">${change.toFixed(2)}%</td>
          <td>${e14.toFixed(2)}</td>
          <td>${e70.toFixed(2)}</td>
          <td>${e200.toFixed(2)}</td>
          <td class="ok">âœ… New Bullish Cross (${ema14.length - crossIndex} candles ago)</td>
        </tr>`;
        document.getElementById("results").insertAdjacentHTML("beforeend", row);
      }
    } catch (e) {
      console.warn("Error on", symbol, e.message);
    }

    await sleep(delayMs);
  }

  progress.innerHTML = `<span class="ok">âœ… Scan complete. Found ${found} pairs with recent (â‰¤25) EMA cross.</span>`;
}
document.getElementById("startBtn").addEventListener("click", startScan);
</script>
</body>
</html>
